
# Test Automation and Reporting

This project provides a streamlined way to run Python test suites, log results, and generate a well-formatted Excel report summarizing the outcomes. It includes two main scripts:
- `run_local_tests.sh`: Runs test suites, captures results, and logs output.
- `generate_excel_report.py`: Reads the test logs and generates a detailed Excel report.

**Note**: The `run_local_tests.sh` script is designed to mimic the behavior of the GitHub Actions workflow `.yaml` file in the repository, which tests files ending in `_test.py` within a specified folder.

## Files in this Folder

- **run_local_tests.sh**: Bash script to execute Python test suites and save results in `test_results.log`.
- **generate_excel_report.py**: Python script to generate an Excel report from the test results.
- **test_results.log**: Log file generated by `run_local_tests.sh` that holds detailed results for each test.
- **error_logs/**: Folder to store individual error logs for test cases that fail.

**Note**: The `error_logs` folder should be deleted or emptied when generating a new report in order to avoid having wrong data in it.

---

## 1. Running the Tests and Generating Reports

### Step 1: Make sure dependencies are installed

- **Python Packages**: The `generate_excel_report.py` script requires the following Python packages:
  ```bash
  pip install pandas openpyxl
  ```
- **Pytest**: The test execution requires `pytest`, which you can install with:
  ```bash
  pip install pytest
  ```

### Step 2: Run the `run_local_tests.sh` script

The main script, `run_local_tests.sh`, executes all test suites in the specified folder, logs the results, and generates an Excel report upon completion.

1. **Give Execute Permission**:
   ```bash
   chmod +x run_local_tests.sh
   ```
2. **Run the Script**:
   ```bash
   ./run_local_tests.sh
   ```
   
This will:
- Search for all test files in the `fbgemm_gpu/test` directory with filenames ending in `_test.py`.
- Execute each test suite using `pytest` and capture results in `test_results.log`.
- Save detailed error logs for failed tests in the `error_logs` folder.
- Generate an Excel report (`test_report.xlsx`) summarizing the results using `generate_excel_report.py`.

**Note**: The `run_local_tests.sh` script replicates the behavior of the GitHub Actions workflow by identifying and testing files matching the `_test.py` naming convention in the repository folder.

### Step 3: Open and Review the Report

After the script completes, open `test_report.xlsx` to review the results. The report includes:
- **Summary**: High-level metrics for test suites and test cases (Passed, Skipped, Failed).
- **Detailed Results**: Row-by-row details for each test case.
- **Suite Summaries**: Summary for each test suite.
- **Error Logs**: Error messages and logs for tests that failed.

---

## 2. Script Breakdown

### `run_local_tests.sh`

This script automates the testing and logging process:
- **Test Execution**: It runs each test suite and captures the output, checking for `PASS`, `FAIL`, `ERROR`, and `SKIPPED` statuses.
- **Logging**: Results are saved in `test_results.log` in CSV format. Individual errors are logged in the `error_logs` directory.
- **Report Generation**: After all tests complete, it automatically calls `generate_excel_report.py` to create the report.

**Note**: You can adjust the timeout or add additional arguments to `pytest` in the `run_python_test` function within the script.

### `generate_excel_report.py`

This Python script generates the `test_report.xlsx` file, which includes:
- **Data Parsing**: Reads `test_results.log`, extracting relevant details for each test suite and test case.
- **Summary Generation**: Aggregates metrics for test statuses (Passed, Skipped, Failed).
- **Excel Formatting**: Creates a well-formatted Excel file with colored cells, pie charts, and summary tables.

To run it independently (if you already have `test_results.log` generated):
```bash
python3 generate_excel_report.py
```

---

## Troubleshooting

- **Formula Errors in Excel**: To avoid Excel interpreting error logs as formulas, this script saves error messages as plain text.
- **Error Log Directory**: Ensure `error_logs` exists or create it manually if missing, as `run_local_tests.sh` stores error logs here.

---

## Example Usage

```bash
# Ensure dependencies are installed
pip install pandas openpyxl pytest

# Run the tests and generate the report
chmod +x run_local_tests.sh
./run_local_tests.sh
```

Upon completion, open `test_report.xlsx` for a detailed view of test results.

---

## Additional Notes

- **Customization**: You can modify colors and formatting in `generate_excel_report.py` within the `apply_formatting` function.
- **Environment**: Ensure the scripts are run in an environment where Python 3, Bash, and the necessary Python packages are installed.

---